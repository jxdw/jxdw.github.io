<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"jxdw.github.io","root":"/","scheme":"Pisces","version":"8.0.2","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"width":240},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}};
  </script>

  <meta name="description" content="前言 &amp;emsp;分析Jaeger源码主要有以下原因：   公司正在使用Jaeger，通过了解其源码，可以更好的把控这套系统。 了解分布式系统的设计 提升对golang的理解 提升个人英语 分析的版本为最新版本0.10.0，时间2017-11-23">
<meta property="og:type" content="article">
<meta property="og:title" content="【jaeger源码分析系列】链路追踪系统知识">
<meta property="og:url" content="https://jxdw.github.io/2021/05/01/trace-jaeger-sourcecode-distribution/index.html">
<meta property="og:site_name" content="渐学顿悟">
<meta property="og:description" content="前言 &amp;emsp;分析Jaeger源码主要有以下原因：   公司正在使用Jaeger，通过了解其源码，可以更好的把控这套系统。 了解分布式系统的设计 提升对golang的理解 提升个人英语 分析的版本为最新版本0.10.0，时间2017-11-23">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://upload.cc/i/2JAQkp.png">
<meta property="article:published_time" content="2021-05-01T11:00:00.000Z">
<meta property="article:modified_time" content="2021-12-18T11:52:13.421Z">
<meta property="article:author" content="渐学顿悟">
<meta property="article:tag" content="中间件">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://upload.cc/i/2JAQkp.png">


<link rel="canonical" href="https://jxdw.github.io/2021/05/01/trace-jaeger-sourcecode-distribution/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>【jaeger源码分析系列】链路追踪系统知识 | 渐学顿悟</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">渐学顿悟</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <!--<a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>-->
    
       
        <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>
    

  </li>
        <li class="menu-item menu-item-categories-os">

    <!--<a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" rel="section"><i class="fab fa-dev fa-fw"></i>操作系统与编程语言</a>-->
    
       
        <a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" rel="section"><i class="fab fa-dev fa-fw"></i>操作系统与编程语言</a>
    

  </li>
        <li class="menu-item menu-item-centos">

    <!--<a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/centos%E4%B8%8Emacos%E6%8A%80%E6%9C%AF/" rel="section"><i class="fab fa-centos fa-fw"></i>centos与macos技术</a>-->
    
       
          <a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/centos%E4%B8%8Emacos%E6%8A%80%E6%9C%AF/" rel="section" class="submenu-item"><i class="fab fa-centos fa-fw"></i>centos与macos技术</a>
    

  </li>
        <li class="menu-item menu-item-c">

    <!--<a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/C%E8%AF%AD%E8%A8%80/" rel="section"><i class="fab fa-contao fa-fw"></i>c语言</a>-->
    
       
          <a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/C%E8%AF%AD%E8%A8%80/" rel="section" class="submenu-item"><i class="fab fa-contao fa-fw"></i>c语言</a>
    

  </li>
        <li class="menu-item menu-item-go">

    <!--<a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/go%E8%AF%AD%E8%A8%80/" rel="section"><i class="fab fa-goodreads fa-fw"></i>go语言</a>-->
    
       
          <a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/go%E8%AF%AD%E8%A8%80/" rel="section" class="submenu-item"><i class="fab fa-goodreads fa-fw"></i>go语言</a>
    

  </li>
        <li class="menu-item menu-item-java">

    <!--<a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java%E8%AF%AD%E8%A8%80/" rel="section"><i class="fab fa-java fa-fw"></i>java语言</a>-->
    
       
          <a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%8E%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/java%E8%AF%AD%E8%A8%80/" rel="section" class="submenu-item"><i class="fab fa-java fa-fw"></i>java语言</a>
    

  </li>
        <li class="menu-item menu-item-categories-middleware">

    <!--<a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="section"><i class="fa fa-th fa-fw"></i>中间件</a>-->
    
       
        <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="section"><i class="fa fa-th fa-fw"></i>中间件</a>
    

  </li>
        <li class="menu-item menu-item-network">

    <!--<a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E7%9F%A5%E8%AF%86/" rel="section"><i class="fas fa-paper-plane fa-fw"></i>网络协议知识</a>-->
    
       
          <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E7%9F%A5%E8%AF%86/" rel="section" class="submenu-item"><i class="fas fa-paper-plane fa-fw"></i>网络协议知识</a>
    

  </li>
        <li class="menu-item menu-item-mysql">

    <!--<a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/mysql%E6%8A%80%E6%9C%AF/" rel="section"><i class="fas fa-database fa-fw"></i>mysql技术</a>-->
    
       
          <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/mysql%E6%8A%80%E6%9C%AF/" rel="section" class="submenu-item"><i class="fas fa-database fa-fw"></i>mysql技术</a>
    

  </li>
        <li class="menu-item menu-item-redis">

    <!--<a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis%E6%8A%80%E6%9C%AF/" rel="section"><i class="fas fa-coins fa-fw"></i>redis技术</a>-->
    
       
          <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis%E6%8A%80%E6%9C%AF/" rel="section" class="submenu-item"><i class="fas fa-coins fa-fw"></i>redis技术</a>
    

  </li>
        <li class="menu-item menu-item-kafka">

    <!--<a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/kafka%E6%8A%80%E6%9C%AF/" rel="section"><i class="fab fa-kaggle fa-fw"></i>kafka技术</a>-->
    
       
          <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/kafka%E6%8A%80%E6%9C%AF/" rel="section" class="submenu-item"><i class="fab fa-kaggle fa-fw"></i>kafka技术</a>
    

  </li>
        <li class="menu-item menu-item-elasticsearch">

    <!--<a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/elasticsearch%E6%8A%80%E6%9C%AF/" rel="section"><i class="fab fa-etsy fa-fw"></i>elasticsearch技术</a>-->
    
       
          <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/elasticsearch%E6%8A%80%E6%9C%AF/" rel="section" class="submenu-item"><i class="fab fa-etsy fa-fw"></i>elasticsearch技术</a>
    

  </li>
        <li class="menu-item menu-item-job">

    <!--<a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/job%E8%B0%83%E5%BA%A6%E6%8A%80%E6%9C%AF/" rel="section"><i class="fas fa-clipboard-check fa-fw"></i>job调度技术</a>-->
    
       
          <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/job%E8%B0%83%E5%BA%A6%E6%8A%80%E6%9C%AF/" rel="section" class="submenu-item"><i class="fas fa-clipboard-check fa-fw"></i>job调度技术</a>
    

  </li>
        <li class="menu-item menu-item-etcd">

    <!--<a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/etcd%E6%8A%80%E6%9C%AF/" rel="section"><i class="fab fa-edge-legacy fa-fw"></i>etcd技术</a>-->
    
       
          <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/etcd%E6%8A%80%E6%9C%AF/" rel="section" class="submenu-item"><i class="fab fa-edge-legacy fa-fw"></i>etcd技术</a>
    

  </li>
        <li class="menu-item menu-item-zipkin">

    <!--<a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E6%A1%86%E6%9E%B6%E4%B8%8E%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA%E6%8A%80%E6%9C%AF/" rel="section"><i class="fab fa-diaspora fa-fw"></i>框架与链路追踪技术</a>-->
    
       
          <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E6%A1%86%E6%9E%B6%E4%B8%8E%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA%E6%8A%80%E6%9C%AF/" rel="section" class="submenu-item"><i class="fab fa-diaspora fa-fw"></i>框架与链路追踪技术</a>
    

  </li>
        <li class="menu-item menu-item-prometheus">

    <!--<a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/prometheus%E6%8A%80%E6%9C%AF/" rel="section"><i class="fas fa-parking fa-fw"></i>prometheus技术</a>-->
    
       
          <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/prometheus%E6%8A%80%E6%9C%AF/" rel="section" class="submenu-item"><i class="fas fa-parking fa-fw"></i>prometheus技术</a>
    

  </li>
        <li class="menu-item menu-item-webserver">

    <!--<a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E6%B5%81%E9%87%8F%E7%BD%91%E5%85%B3%E6%8A%80%E6%9C%AF/" rel="section"><i class="fab fa-bootstrap fa-fw"></i>流量网关技术</a>-->
    
       
          <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E6%B5%81%E9%87%8F%E7%BD%91%E5%85%B3%E6%8A%80%E6%9C%AF/" rel="section" class="submenu-item"><i class="fab fa-bootstrap fa-fw"></i>流量网关技术</a>
    

  </li>
        <li class="menu-item menu-item-docker">

    <!--<a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/dockerengine%E6%8A%80%E6%9C%AF/" rel="section"><i class="fab fa-docker fa-fw"></i>dockerengine技术</a>-->
    
       
          <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/dockerengine%E6%8A%80%E6%9C%AF/" rel="section" class="submenu-item"><i class="fab fa-docker fa-fw"></i>dockerengine技术</a>
    

  </li>
        <li class="menu-item menu-item-categories-distribution">

    <!--<a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E5%BA%94%E7%94%A8%E7%B3%BB%E7%BB%9F/" rel="section"><i class="fas fa-cogs fa-fw"></i>分布式应用系统</a>-->
    
       
        <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E5%BA%94%E7%94%A8%E7%B3%BB%E7%BB%9F/" rel="section"><i class="fas fa-cogs fa-fw"></i>分布式应用系统</a>
    

  </li>
        <li class="menu-item menu-item-categories-dis-little">

    <!--<a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E5%BA%94%E7%94%A8%E7%B3%BB%E7%BB%9F/%E5%B0%8F%E5%9E%8B%E5%88%86%E5%B8%83%E5%BC%8F%E5%BA%94%E7%94%A8%E7%B3%BB%E7%BB%9F/" rel="section"><i class="fas fa-cogs fa-fw"></i>小型分布式应用系统</a>-->
    
       
          <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E5%BA%94%E7%94%A8%E7%B3%BB%E7%BB%9F/%E5%B0%8F%E5%9E%8B%E5%88%86%E5%B8%83%E5%BC%8F%E5%BA%94%E7%94%A8%E7%B3%BB%E7%BB%9F/" rel="section" class="submenu-item"><i class="fas fa-cogs fa-fw"></i>小型分布式应用系统</a>
    

  </li>
        <li class="menu-item menu-item-about">

    <!--<a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>-->
    
       
        <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>
    

  </li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="渐学顿悟"
      src="/favicon.png">
  <p class="site-author-name" itemprop="name">渐学顿悟</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">145</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/jxdw" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jxdw" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/wechat.png" title="WeChat → &#x2F;wechat.png"><i class="fab fa-weixin fa-fw"></i>WeChat</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:283593214@qq.com" title="E-Mail → mailto:283593214@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jxdw.github.io/2021/05/01/trace-jaeger-sourcecode-distribution/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/favicon.png">
      <meta itemprop="name" content="渐学顿悟">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="渐学顿悟">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          【jaeger源码分析系列】链路追踪系统知识
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-01 19:00:00 19:00:00" itemprop="dateCreated datePublished" datetime="2021-05-01T19:00:00+08:00">2021-05-01 19:00:00</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">中间件</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E6%A1%86%E6%9E%B6%E4%B8%8E%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">框架与链路追踪技术</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2021/05/01/trace-jaeger-sourcecode-distribution/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/05/01/trace-jaeger-sourcecode-distribution/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><blockquote>
<p>&emsp;分析Jaeger源码主要有以下原因：</p>
</blockquote>
<ul>
<li>公司正在使用Jaeger，通过了解其源码，可以更好的把控这套系统。</li>
<li>了解分布式系统的设计</li>
<li>提升对golang的理解</li>
<li>提升个人英语<blockquote>
<p>分析的版本为最新版本0.10.0，时间2017-11-23</p>
</blockquote>
</li>
</ul>
<p><img src="https://upload.cc/i/2JAQkp.png"></p>
<a id="more"></a>

<h1 id="Agent-——3部曲"><a href="#Agent-——3部曲" class="headerlink" title="Agent ——3部曲"></a>Agent ——3部曲</h1><blockquote>
<p>&emsp;Agent处于jaeger-client和collector之间，属于代理的作用，主要是把client发送过来的数据从thrift转为<a target="_blank" rel="noopener" href="https://github.com/jaegertracing/jaeger/blob/master/thrift-gen/jaeger/ttypes.go#L1582">Batch</a>，并通过RPC批量提交到collector。</p>
</blockquote>
<h2 id="初始化agent"><a href="#初始化agent" class="headerlink" title="初始化agent"></a>初始化agent</h2><blockquote>
<p>github.com/jaegertracing/jaeger/cmd/agent/app/flags.go #35</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> defaultProcessors = []<span class="keyword">struct</span> &#123;</span><br><span class="line">	model    model</span><br><span class="line">	protocol protocol</span><br><span class="line">	hostPort <span class="keyword">string</span></span><br><span class="line">&#125;&#123;</span><br><span class="line">	&#123;model: <span class="string">&quot;zipkin&quot;</span>, protocol: <span class="string">&quot;compact&quot;</span>, hostPort: <span class="string">&quot;:5775&quot;</span>&#125;,</span><br><span class="line">	&#123;model: <span class="string">&quot;jaeger&quot;</span>, protocol: <span class="string">&quot;compact&quot;</span>, hostPort: <span class="string">&quot;:6831&quot;</span>&#125;,</span><br><span class="line">	&#123;model: <span class="string">&quot;jaeger&quot;</span>, protocol: <span class="string">&quot;binary&quot;</span>, hostPort: <span class="string">&quot;:6832&quot;</span>&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>在agent开启时初始化了3个UDP服务</p>
</li>
<li><p>每个服务对应处理不同的数据格式</p>
</li>
<li><p>官方推荐使用6831端口接收数据</p>
</li>
</ul>
<h2 id="接收Jaeger-client的数据"><a href="#接收Jaeger-client的数据" class="headerlink" title="接收Jaeger-client的数据"></a>接收Jaeger-client的数据</h2><blockquote>
<p>github.com/jaegertracing/jaeger/cmd/agent/app/servers/tbuffered_server.go #80</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *TBufferedServer)</span> <span class="title">Serve</span><span class="params">()</span></span> &#123;</span><br><span class="line">	atomic.StoreUint32(&amp;s.serving, <span class="number">1</span>)</span><br><span class="line">	<span class="keyword">for</span> s.IsServing() &#123;</span><br><span class="line">		readBuf := s.readBufPool.Get().(*ReadBuf)</span><br><span class="line">		n, err := s.transport.Read(readBuf.bytes)</span><br><span class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">			readBuf.n = n</span><br><span class="line">			s.metrics.PacketSize.Update(<span class="keyword">int64</span>(n))</span><br><span class="line">			<span class="keyword">select</span> &#123;</span><br><span class="line">			<span class="keyword">case</span> s.dataChan &lt;- readBuf:</span><br><span class="line">				s.metrics.PacketsProcessed.Inc(<span class="number">1</span>)</span><br><span class="line">				s.updateQueueSize(<span class="number">1</span>)</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">			   <span class="comment">//这里需要注意，如果写比处理快，agent将会扔掉超出的部分数据</span></span><br><span class="line">			   s.metrics.PacketsDropped.Inc(<span class="number">1</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			s.metrics.ReadError.Inc(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&emsp;每一个UDP服务端都有自己单独的队列和worker，每个队列（长度默认1000）都会有50个（协成）worker消费队列的数据，也可以根据系统负载调节队列和worker的大小。</p>
</blockquote>
<ul>
<li>增加队列长度（default 1000） –processor.jaeger-compact.server-queue-size</li>
<li>增加worker数 （default 50） –processor.jaeger-compact.workers </li>
</ul>
<h3 id="优雅关闭"><a href="#优雅关闭" class="headerlink" title="优雅关闭"></a>优雅关闭</h3><blockquote>
<p>&emsp;go初始化一个服务很简单，使用for{}的形式就能实现。但是启动了就要考虑如何关闭，总不能直接强制关闭吧？请求处理了一半被中断，导致脏数据出现，显然不是我们想要的结果，所以有优雅关闭方式。实现优雅关闭的方式大致是：主服务接收信号，然后通知子服务执行完当前操作就不要再执行。</p>
</blockquote>
<blockquote>
<p>&emsp;下面来看看<a target="_blank" rel="noopener" href="https://github.com/nsqio/nsq">NSQ</a>和<a target="_blank" rel="noopener" href="https://github.com/jaegertracing/jaeger">Jaeger</a>通知子服务停止的实现方式：</p>
</blockquote>
<ul>
<li>NSQ<blockquote>
<p>github.com/nsqio/nsq/nsqd/topic.go #215</p>
</blockquote>
</li>
</ul>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">func</span> <span class="params">(t *Topic)</span> <span class="title">messagePump</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">    	<span class="keyword">select</span> &#123;</span><br><span class="line">    	<span class="keyword">case</span> msg = &lt;-memoryMsgChan:</span><br><span class="line">    ......</span><br><span class="line">    	<span class="keyword">case</span> &lt;-t.exitChan:</span><br><span class="line">    		<span class="keyword">goto</span> exit</span><br><span class="line">    	&#125;</span><br><span class="line">    ......</span><br><span class="line">    &#125;</span><br><span class="line">    exit:</span><br><span class="line">	t.ctx.nsqd.logf(<span class="string">&quot;TOPIC(%s): closing ... messagePump&quot;</span>, t.name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Jaeger</li>
</ul>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *TBufferedServer)</span> <span class="title">Serve</span><span class="params">()</span></span> &#123;</span><br><span class="line">	atomic.StoreUint32(&amp;s.serving, <span class="number">1</span>)</span><br><span class="line">	<span class="keyword">for</span> s.IsServing() &#123;</span><br><span class="line">        ......</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&emsp;在通知子服务要停止执行的实现上，NSQ和Jaeger的子服务都是留出一个入口，主服务通过这个入口通知子服务。不同的是在停止这步上：</p>
</blockquote>
<blockquote>
<p>NSQ使用chan+goto，exitChan接收到信号，执行goto，跳出for循环。</p>
</blockquote>
<blockquote>
<p>Jaeger使用原子操作，通过原子操作把s.serving设为0，跳出for循环。</p>
</blockquote>
<h3 id="临时对象池"><a href="#临时对象池" class="headerlink" title="临时对象池"></a>临时对象池</h3><blockquote>
<p>&emsp;网上有篇博客对临时对象池介绍得挺详细的<a target="_blank" rel="noopener" href="http://ifeve.com/go-concurrency-object-pool/">《GO并发编程实战》—— 临时对象池</a>。临时对象池的作用是：<strong>存放可被复用值，减少垃圾回收。</strong></p>
</blockquote>
<blockquote>
<p>&emsp;要想发挥对象池的作用，先要确保池子非空。如果从空池子获取值，只会重新New一个值，达不到复用的效果。所以一般用法都是先Get，再Put。</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line">readBuf := s.readBufPool.Get().(*ReadBuf)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&emsp;从上面代码中可以看出Agent是想通过对象池复用“*ReadBuf”，但是并没有看到Put这步，因为这步放在worker那边处理。</p>
</blockquote>
<blockquote>
<p>github.com/uber/jaeger/cmd/agent/app/servers/tbuffered_server.go #124</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *TBufferedServer)</span> <span class="title">DataRecd</span><span class="params">(buf *ReadBuf)</span></span> &#123;</span><br><span class="line">	s.updateQueueSize(<span class="number">-1</span>)</span><br><span class="line">	s.readBufPool.Put(buf)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&emsp;为什么不在数据放入队列的时候就把“<em>ReadBuf”Put到池子呢？这是由当前的场景决定的。 首先“</em>ReadBuf”是一个指针，第二指针会被放到 chan里，在这种情况下，如果chan出现了数据堆积（worker处理不完队列数据），当Agent接到client数据时，由于复用“*ReadBuf”，就造成了chan的所有数据和新数据一样的错乱问题，<a target="_blank" rel="noopener" href="https://github.com/jukylin/blog/blob/master/put_%20pointer_pool.go">例子</a>。所以要想复用值，只能在worker消费了队列数据后再Put回池子。</p>
</blockquote>
<blockquote>
<p>看完Agent的对象池使用，再来看看NSQ的对象池使用。</p>
</blockquote>
<blockquote>
<p>github.com/nsqio/nsq/nsqd/topic.go #197</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Topic)</span> <span class="title">put</span><span class="params">(m *Message)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> t.memoryMsgChan &lt;- m:</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">    	b := bufferPoolGet()</span><br><span class="line">    	<span class="comment">//b =&gt; bp.Get().(*bytes.Buffer)</span></span><br><span class="line">    	err := writeMessageToBackend(b, m, t.backend)</span><br><span class="line">    	bufferPoolPut(b)</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>&emsp;这里的使用相对容易理解点，先Get“<em>bytes.Buffer”，再处理m数据，最后再把“</em>bytes.Buffer”Put到池中。和Agent不同，writeMessageToBackend不会堆积数据，出现数据错乱的情况。还有一个小细节，当把“*bytes.Buffer”Put到池子再Get出来，b还会保留上次处理的数据，所以NSQ会清空数据，使用一个干净的值。</p>
</blockquote>
<h3 id="不怜悯数据"><a href="#不怜悯数据" class="headerlink" title="不怜悯数据"></a>不怜悯数据</h3><blockquote>
<p>&emsp;Agent的服务队列是有长度限制（default 1000），如果堆积超过1000个，Agent就会毫不怜悯的把数据丢掉。当然在这里并没有不妥，Jaeger的定位就是一套日志系统，不太看重数据的可靠性。如果要想减少数据丢失的问题，可通过配置或增加Agent节点。因为Jaeger和NSQ对于数据的定位不一样，所以就不对比这部分功能。NSQ比较注重数据的可靠性。</p>
</blockquote>
<h2 id="提交数据"><a href="#提交数据" class="headerlink" title="提交数据"></a>提交数据</h2><blockquote>
<p>github.com/jaegertracing/jaeger/cmd/agent/app/processors/thrift_processor.go #104</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ThriftProcessor)</span> <span class="title">processBuffer</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> readBuf := <span class="keyword">range</span> s.server.DataChan() &#123;</span><br><span class="line">    	protocol := s.protocolPool.Get().(thrift.TProtocol)</span><br><span class="line">    	protocol.Transport().Write(readBuf.GetBytes())</span><br><span class="line">    	<span class="comment">//这步就是把“*ReadBuf”Put到池子</span></span><br><span class="line">    	s.server.DataRecd(readBuf) <span class="comment">// acknowledge receipt and release the buffer</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment">//将数据从thrift解析成Batch并提交</span></span><br><span class="line">    	<span class="keyword">if</span> ok, _ := s.handler.Process(protocol, protocol); !ok &#123;</span><br><span class="line">    		<span class="comment">// TODO log the error</span></span><br><span class="line">    		s.metrics.HandlerProcessError.Inc(<span class="number">1</span>)</span><br><span class="line">    	&#125;</span><br><span class="line">    	s.protocolPool.Put(protocol)</span><br><span class="line">    &#125;</span><br><span class="line">    s.processing.Done()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="消耗队列数据"><a href="#消耗队列数据" class="headerlink" title="消耗队列数据"></a>消耗队列数据</h5><blockquote>
<p>&emsp;这里是一个worker的实现，在启动Agent的时候就初始化了150个worker来处理队列数据。消耗队列使用for + range的方式，不是使用 select + chan的方式，关于这2种方式的使用介绍可以看<a target="_blank" rel="noopener" href="http://www.jianshu.com/p/fe5dd2efed5d">Go中的Channel——range和select</a>。这里Agent偷懒了，没有考虑到优雅关闭，如果队列堆积了数据，而Agent被重启队列的数据就会丢失。</p>
</blockquote>
<h5 id="数据从thrift转为Batch"><a href="#数据从thrift转为Batch" class="headerlink" title="数据从thrift转为Batch"></a>数据从thrift转为Batch</h5><blockquote>
<p>github.com/jaegertracing/jaeger/thrift-gen/agent/agent.go #187</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *agentProcessorEmitBatch)</span> <span class="title">Process</span><span class="params">(seqId <span class="keyword">int32</span>, iprot, oprot thrift.TProtocol)</span> <span class="params">(success <span class="keyword">bool</span>, err thrift.TException)</span></span> &#123;</span><br><span class="line">	args := AgentEmitBatchArgs&#123;&#125;</span><br><span class="line">	<span class="keyword">if</span> err = args.Read(iprot); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		iprot.ReadMessageEnd()</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	iprot.ReadMessageEnd()</span><br><span class="line">	<span class="keyword">var</span> err2 error</span><br><span class="line">	<span class="keyword">if</span> err2 = p.handler.EmitBatch(args.Batch); err2 != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>, err2</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&emsp;解析thrift是一件很麻烦的事，这种格式的数据是给机器看得，需要按照指定的格式一步一步解析出来，不像Json那么方便，但是thrift又确实能<a target="_blank" rel="noopener" href="https://github.com/jukylin/blog/blob/master/Uber%E5%88%86%E5%B8%83%E5%BC%8F%E8%BF%BD%E8%B8%AA%E7%B3%BB%E7%BB%9FJaeger%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D%E5%92%8C%E6%A1%88%E4%BE%8B%E3%80%90PHP%20%20%20Hprose%20%20%20Go%E3%80%91.md#%E7%89%B9%E6%80%A7">减少占用的空间</a>。</p>
</blockquote>
<h3 id="提交数据-1"><a href="#提交数据-1" class="headerlink" title="提交数据"></a>提交数据</h3><blockquote>
<p>github.com/jaegertracing/jaeger/thrift-gen/jaeger/tchan-jaeger.go #39</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *tchanCollectorClient)</span> <span class="title">SubmitBatches</span><span class="params">(ctx thrift.Context, batches []*Batch)</span> <span class="params">([]*BatchSubmitResponse, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> resp CollectorSubmitBatchesResult</span><br><span class="line">	args := CollectorSubmitBatchesArgs&#123;</span><br><span class="line">		Batches: batches,</span><br><span class="line">	&#125;</span><br><span class="line">	success, err := c.client.Call(ctx, c.thriftService, <span class="string">&quot;submitBatches&quot;</span>, &amp;args, &amp;resp)</span><br><span class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &amp;&amp; !success &#123;</span><br><span class="line">		<span class="keyword">switch</span> &#123;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			err = fmt.Errorf(<span class="string">&quot;received no result or unknown exception for submitBatches&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> resp.GetSuccess(), err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>&emsp;Agent把数据提交到Collector是通过RPC框架<a target="_blank" rel="noopener" href="https://uber.github.io/tchannel/">TChannel</a>，框架由Uber开发，使用TChannel，Agent可以把数据批量提交到Collector。这个框架提供了一个很有用的特性：<strong>上下文传输</strong>。为什么呢？说说我们遇到的一个问题：RPC开发的接口，业务方按需传入函数的参数调用即可，这样的方式在前期业务不会产生问题。但是随着公司发展，版本的迭代，一个接口需要按照客户端版本进行兼容是很常见的事情，这样就存在一个问题，作为RPC的服务端和业务方的调用是跨进程，在上下文没有保持一致的时候，RPC服务端不知道客户端版本，很难对此进行兼容。是增加参数？还是增加另一个服务化接口？这些方法都不够友好，最好是在不需要业务方改动的情况下处理这个问题，这时<strong>上下文传输</strong>就体现它的作用了。</p>
</blockquote>
<blockquote>
<p>&emsp;不怜悯数据在Jaeger随处可见，从上面代码可以看出，如果提交失败，数据也一样丢失，没有重试，没有重新放入队列等操作。</p>
</blockquote>
<h1 id="Collector-3部曲"><a href="#Collector-3部曲" class="headerlink" title="Collector 3部曲"></a>Collector 3部曲</h1><blockquote>
<p>&emsp;Collector收集数据，把数据保存进数据库，虽然职责不一样，但在程序设计上和Agent是一样的，可以从它们的实现上看出属于不同开发人员分工开发完成。下面我们也是分3步拆解Collector的实现。</p>
</blockquote>
<h2 id="初始化Collector"><a href="#初始化Collector" class="headerlink" title="初始化Collector"></a>初始化Collector</h2><blockquote>
<p>&emsp;Collector是使用TChannel实现的RPC服务端，在启动时就开启了2个基于TCP的RPC服务，一个用来接收Jaeger格式数据，一个接收Zipkin格式数据。</p>
</blockquote>
<blockquote>
<p>github.com/jaegertracing/jaeger/cmd/collector/main.go # 100</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line">......</span><br><span class="line">ch, err := tchannel.NewChannel(serviceName, &amp;tchannel.ChannelOptions&#123;&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	logger.Fatal(<span class="string">&quot;Unable to create new TChannel&quot;</span>, zap.Error(err))</span><br><span class="line">&#125;</span><br><span class="line">server := thrift.NewServer(ch)</span><br><span class="line">zipkinSpansHandler, jaegerBatchesHandler := handlerBuilder.BuildHandlers()</span><br><span class="line">server.Register(jc.NewTChanCollectorServer(jaegerBatchesHandler))</span><br><span class="line">server.Register(zc.NewTChanZipkinCollectorServer(zipkinSpansHandler))</span><br><span class="line"></span><br><span class="line">portStr := <span class="string">&quot;:&quot;</span> + strconv.Itoa(builderOpts.CollectorPort)</span><br><span class="line">listener, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, portStr)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	logger.Fatal(<span class="string">&quot;Unable to start listening on channel&quot;</span>, zap.Error(err))</span><br><span class="line">&#125;</span><br><span class="line">ch.Serve(listener)</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h2 id="接收Agent的数据"><a href="#接收Agent的数据" class="headerlink" title="接收Agent的数据"></a>接收Agent的数据</h2><blockquote>
<p>github.com/jaegertracing/jaeger/cmd/collector/app/span_handler.go #69</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(jbh *jaegerBatchesHandler)</span> <span class="title">SubmitBatches</span><span class="params">(ctx thrift.Context, batches []*jaeger.Batch)</span> <span class="params">([]*jaeger.BatchSubmitResponse, error)</span></span> &#123;</span><br><span class="line">	responses := <span class="built_in">make</span>([]*jaeger.BatchSubmitResponse, <span class="number">0</span>, <span class="built_in">len</span>(batches))</span><br><span class="line">	<span class="keyword">for</span> _, batch := <span class="keyword">range</span> batches &#123;</span><br><span class="line">		mSpans := <span class="built_in">make</span>([]*model.Span, <span class="number">0</span>, <span class="built_in">len</span>(batch.Spans))</span><br><span class="line">		<span class="keyword">for</span> _, span := <span class="keyword">range</span> batch.Spans &#123;</span><br><span class="line">			mSpan := jConv.ToDomainSpan(span, batch.Process)</span><br><span class="line">			mSpans = <span class="built_in">append</span>(mSpans, mSpan)</span><br><span class="line">		&#125;</span><br><span class="line">		oks, err := jbh.modelProcessor.ProcessSpans(mSpans, JaegerFormatType)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">        ......</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> responses, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&emsp;这里就是RPC服务端接收数据的地方，经过处理后数据会被放入到队列。</p>
</blockquote>
<blockquote>
<p>github.com/jaegertracing/jaeger/pkg/queue/bounded_queue.go #76</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *BoundedQueue)</span> <span class="title">Produce</span><span class="params">(item <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> atomic.LoadInt32(&amp;q.stopped) != <span class="number">0</span> &#123;</span><br><span class="line">    	q.onDroppedItem(item)</span><br><span class="line">    	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> q.items &lt;- item:</span><br><span class="line">    	atomic.AddInt32(&amp;q.size, <span class="number">1</span>)</span><br><span class="line">    	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">    	<span class="keyword">if</span> q.onDroppedItem != <span class="literal">nil</span> &#123;</span><br><span class="line">    		q.onDroppedItem(item)</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&emsp;在这里Collector对队列的操作进行了抽象封装成<a target="_blank" rel="noopener" href="https://github.com/jaegertracing/jaeger/blob/master/pkg/queue/bounded_queue.go">BoundedQueue</a>，对读代码带来了便利。BoundedQueue的实现基于 select + chan和Agent的队列有相同的功能，在生产和消费基础上实现了优雅停止队列和查看队列长度。Collector队列的数据堆积到2000条，也会毫不怜悯的把数据丢掉。当然这些也是可以调节的：</p>
</blockquote>
<ul>
<li><p>–collector.queue-size （default 2000）</p>
</li>
<li><p>–collector.num-workers （default 50）</p>
</li>
</ul>
<h2 id="保存数据"><a href="#保存数据" class="headerlink" title="保存数据"></a>保存数据</h2><h3 id="消费队列数据"><a href="#消费队列数据" class="headerlink" title="消费队列数据"></a>消费队列数据</h3><blockquote>
<p>github.com/jaegertracing/jaeger/pkg/queue/bounded_queue.go #53</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *BoundedQueue)</span> <span class="title">StartConsumers</span><span class="params">(num <span class="keyword">int</span>, consumer <span class="keyword">func</span>(item <span class="keyword">interface</span>&#123;&#125;)</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> startWG sync.WaitGroup</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; num; i++ &#123;</span><br><span class="line">    	q.stopWG.Add(<span class="number">1</span>)</span><br><span class="line">    	startWG.Add(<span class="number">1</span>)</span><br><span class="line">    	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    		startWG.Done()</span><br><span class="line">    		<span class="keyword">defer</span> q.stopWG.Done()</span><br><span class="line">    		<span class="keyword">for</span> &#123;</span><br><span class="line">    			<span class="keyword">select</span> &#123;</span><br><span class="line">    			<span class="keyword">case</span> item := &lt;-q.items:</span><br><span class="line">    				atomic.AddInt32(&amp;q.size, <span class="number">-1</span>)</span><br><span class="line">    				consumer(item)</span><br><span class="line">    			<span class="keyword">case</span> &lt;-q.stopCh:</span><br><span class="line">    				<span class="keyword">return</span></span><br><span class="line">    			&#125;</span><br><span class="line">    		&#125;</span><br><span class="line">    	&#125;()</span><br><span class="line">    &#125;</span><br><span class="line">    startWG.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&emsp;这里有一步不是很明白，为什么要使用”startWG“确认worker启动完成？不用会出现什么问题？</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">官方回复：</span><br><span class="line">    to ensure all consumer goroutines are running by the time we return from this function</span><br></pre></td></tr></table></figure>
<blockquote>
<p>优雅关闭队列方式：close(q.stopCh)</p>
</blockquote>
<h3 id="数据保存到数据库——cassandra"><a href="#数据保存到数据库——cassandra" class="headerlink" title="数据保存到数据库——cassandra"></a>数据保存到数据库——cassandra</h3><blockquote>
<p>github.com/jaegertracing/jaeger/plugin/storage/cassandra/spanstore/writer.go #122</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SpanWriter)</span> <span class="title">WriteSpan</span><span class="params">(span *model.Span)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	ds := dbmodel.FromDomain(span)</span><br><span class="line">	mainQuery := s.session.Query(</span><br><span class="line">		insertSpan,</span><br><span class="line">		ds.TraceID,</span><br><span class="line">		ds.SpanID,</span><br><span class="line">		ds.SpanHash,</span><br><span class="line">		ds.ParentID,</span><br><span class="line">		ds.OperationName,</span><br><span class="line">		ds.Flags,</span><br><span class="line">		ds.StartTime,</span><br><span class="line">		ds.Duration,</span><br><span class="line">		ds.Tags,</span><br><span class="line">		ds.Logs,</span><br><span class="line">		ds.Refs,</span><br><span class="line">		ds.Process,</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := s.writerMetrics.traces.Exec(mainQuery, s.logger); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> s.logError(ds, err, <span class="string">&quot;Failed to insert span&quot;</span>, s.logger)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := s.saveServiceNameAndOperationName(ds.ServiceName, ds.OperationName); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// should this be a soft failure?</span></span><br><span class="line">		<span class="keyword">return</span> s.logError(ds, err, <span class="string">&quot;Failed to insert service name and operation name&quot;</span>, s.logger)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&emsp;在把ServiceName和OperationName保存到cassandra的时候做了特别的操作，使用<a target="_blank" rel="noopener" href="https://github.com/jukylin/blog/blob/master/Jaeger%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90--lru%E7%AE%97%E6%B3%95.md">LRU算法</a>进行缓存。这一步缓存应该是为了减少对cassandra查询，减少查询压力。</p>
</blockquote>
<blockquote>
<p>github.com/jaegertracing/jaeger/plugin/storage/cassandra/spanstore/service_names.go #69</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ServiceNamesStorage)</span> <span class="title">Write</span><span class="params">(serviceName <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line">	query := s.session.Query(s.InsertStmt)</span><br><span class="line">	<span class="keyword">if</span> inCache := checkWriteCache(serviceName, s.serviceNames, s.writeCacheTTL); !inCache &#123;</span><br><span class="line">		q := query.Bind(serviceName)</span><br><span class="line">		err2 := s.metrics.Exec(q, s.logger)</span><br><span class="line">		<span class="keyword">if</span> err2 != <span class="literal">nil</span> &#123;</span><br><span class="line">			err = err2</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&emsp;Collector在建立缓存的顺序上先放入缓存再放入数据库。查询方式：key/value。</p>
</blockquote>
<blockquote>
<p>&emsp;既然是缓存就会有失效时间（default 12h），而Jaeger默认保存数据2天，所以是否会存在重复保存出错的情况？因为serviceName是主键索引。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE IF NOT EXISTS jaeger_v1_dc.service_names (</span><br><span class="line">    service_name text,</span><br><span class="line">    PRIMARY KEY (service_name)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这种情况出现在mysql必定会报错，但在cassandra就不会有这种情况。</p>
</blockquote>
<ul>
<li>cassandra<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cqlsh:jaeger_v1_dc&gt; select * from service_names1;</span><br><span class="line"></span><br><span class="line"> service_name</span><br><span class="line">--------------</span><br><span class="line">         test</span><br><span class="line"></span><br><span class="line">(1 rows)</span><br><span class="line">S lsh:jaeger_v1_dc&gt; INSERT INTO service_names1 (service_name) VALUE</span><br><span class="line">                ... (&#39;test&#39;);</span><br></pre></td></tr></table></figure></li>
<li>mysql<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">mysql&gt; select * from service_names1;</span><br><span class="line">+--------------+</span><br><span class="line">| service_name |</span><br><span class="line">+--------------+</span><br><span class="line">| test         |</span><br><span class="line">+--------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into service_names1 (service_name) values (&#39;test&#39;);</span><br><span class="line">ERROR 1062 (23000): Duplicate entry &#39;test&#39; for key &#39;PRIMARY&#39;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<blockquote>
<p>惊奇吧？虽然没有报错，但也会保证唯一性。有兴趣的同学可简单[了解一下]<br>(<a target="_blank" rel="noopener" href="http://www.yiibai.com/cassandra/what-is-cassandra.html)%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95%EF%BC%8C%E8%AF%AD%E6%B3%95%E5%92%8Cmysql%E5%BE%88%E5%83%8F%E3%80%82">http://www.yiibai.com/cassandra/what-is-cassandra.html)基本用法，语法和mysql很像。</a><br>关于cassandra我们也是摸着石头过河，不做过多描述。</p>
</blockquote>
<h1 id="golang使用规范"><a href="#golang使用规范" class="headerlink" title="golang使用规范"></a>golang使用规范</h1><table>
<thead>
<tr>
<th>&emsp;</th>
<th>NSQ</th>
<th>Jaeger</th>
</tr>
</thead>
<tbody><tr>
<td>目录名</td>
<td>小写/下划线</td>
<td>小写/中横线</td>
</tr>
<tr>
<td>函数名</td>
<td>小驼峰</td>
<td>小驼峰</td>
</tr>
<tr>
<td>文件名</td>
<td>下划线</td>
<td>下划线</td>
</tr>
<tr>
<td>变量</td>
<td>小驼峰</td>
<td>小驼峰</td>
</tr>
<tr>
<td>常量</td>
<td>小驼峰</td>
<td>小驼峰</td>
</tr>
<tr>
<td>包名</td>
<td>当前目录名</td>
<td>当前目录名</td>
</tr>
<tr>
<td>请求地址</td>
<td>下划线</td>
<td>*小写</td>
</tr>
<tr>
<td>请求参数</td>
<td>*小写</td>
<td>小驼峰</td>
</tr>
<tr>
<td>返回参数</td>
<td>下划线</td>
<td>小驼峰</td>
</tr>
<tr>
<td>命令行参数</td>
<td>中横线</td>
<td>前缀+点+中横线</td>
</tr>
</tbody></table>
<blockquote>
<p><strong><em>打”\</em>“是由于没有找到足够多的参照例子。*</strong></p>
</blockquote>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><blockquote>
<p>&emsp;Jaeger向我展示了很多东西：UDP使用，优雅关闭，临时对象池，LRU算法实现等。不单单是golang方面，还有程序设计、服务设计上，Agent、Collector、Query3个服务的职责都很单一，这应该是来源微服务思想的划分。有很多东西需要自行消化，也有很多东西我没有注意到，只看个人好奇的部分，但收获也挺多。总结就是：Get到知识了！！</p>
</blockquote>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag"># 中间件</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020/12/21/golang-project-layout/" rel="prev" title="【go使用系列】【转载】go项目工程的布局">
                  <i class="fa fa-chevron-left"></i> 【go使用系列】【转载】go项目工程的布局
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/05/01/trace-jaeger-sourcecode-sd/" rel="next" title="【jaeger源码分析】jaeger服务注册与发现源码">
                  【jaeger源码分析】jaeger服务注册与发现源码 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






      
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">渐学顿悟</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  


















  








  

  

<script>
NexT.utils.loadComments('#valine-comments', () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    new Valine(Object.assign({"enable":true,"appId":"wrre3Nrx21CqKiChLnKn034M-gzGzoHsz","appKey":"rkWWNONo7LAJhlS936vnywQ9","serverURLs":null,"placeholder":"请输入您的评论","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"lang":null,"visitor":false,"comment_count":true,"recordIP":false,"enableQQ":false,"requiredFields":["nick","mail"]}, {
      el: '#valine-comments',
      path: "/2021/05/01/trace-jaeger-sourcecode-distribution/",
      serverURLs: "https://wrre3nrx.api.lncld.net"
    }));
  }, window.Valine);
});
</script>

</body>
</html>
